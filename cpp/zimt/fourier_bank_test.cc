// Copyright 2024 The Zimtohrli Authors. All Rights Reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

#include <cmath>
#include <cstddef>
#include <cstring>
#include <vector>

#include "absl/log/check.h"
#include "benchmark/benchmark.h"
#include "gmock/gmock.h"
#include "gtest/gtest.h"
#include "zimt/zimtohrli.h"

namespace zimtohrli {

namespace {

TEST(FourierBank, GoldenNumbers) {
  // Golden values produced in
  // https://github.com/google/zimtohrli/commit/931311899500690e0360552c2e7deab6eebffeec
  std::vector<float> signal(48000 * 20);
  signal[0] = 1;
  Spectrogram spectrogram(48, kNumRotators);
  zimtohrli::Rotators rot;
  rot.FilterAndDownsample(signal.data(), signal.size(),
                          spectrogram.values.data(), spectrogram.num_steps,
                          spectrogram.num_dims,
                          signal.size() / spectrogram.num_steps);
  std::vector<std::vector<float>> want_spec = {
      {
          9.4543495178,  9.4395961761,  9.4818201065,  9.4251594543,
          9.4271774292,  9.4295063019,  9.4321479797,  9.4351015091,
          9.4383668900,  9.4419422150,  9.4458284378,  9.4682998657,
          9.4909620285,  9.5322446823,  9.5738811493,  9.5780115128,
          9.6020174026,  9.6667566299,  10.0534524918, 11.0314340591,
          11.8411264420, 12.1751680374, 12.2541666031, 12.1256971359,
          11.3583078384, 9.7714357376,  8.8147478104,  8.1149234772,
          7.2442479134,  6.7400259972,  6.4771876335,  6.6939630508,
          7.3635244370,  8.9106149673,  10.6447582245, 12.5498714447,
          13.6861219406, 14.3342399597, 14.2481126785, 14.0175905228,
          13.2371292114, 13.1503705978, 13.2231044769, 14.0403985977,
          15.0868320465, 16.6556854248, 17.9369525909, 18.8283138275,
      },
      {
          9.4527854919,  9.4371728897,  9.4779844284,  9.4196424484,
          9.4196424484,  9.4196424484,  9.4196424484,  9.4196424484,
          9.4196424484,  9.4196424484,  9.4196424484,  9.4378576279,
          9.4559354782,  9.4922275543,  9.5285205841,  9.5271501541,
          9.5452280045,  9.6034336090,  9.9808759689,  10.9440689087,
          11.7386713028, 12.0605115891, 12.1289882660, 11.9917612076,
          11.2230424881, 9.6463003159,  8.6936531067,  7.9956026077,
          7.1304697990,  6.6271662712,  6.3617510796,  6.5671806335,
          7.2155175209,  8.7207698822,  10.4046106339, 12.2503290176,
          13.3407497406, 13.9519729614, 13.8466548920, 13.6002759933,
          12.8206014633, 12.7126827240, 12.7570552826, 13.5155019760,
          14.4871845245, 15.9497089386, 17.1229877472, 17.9090995789,
      },
      {
          9.4527854919,  9.4371728897,  9.4779844284,  9.4196424484,
          9.4196424484,  9.4196424484,  9.4196424484,  9.4196424484,
          9.4196424484,  9.4196424484,  9.4196424484,  9.4378576279,
          9.4559354782,  9.4922275543,  9.5285205841,  9.5271501541,
          9.5452280045,  9.6034336090,  9.9808759689,  10.9440689087,
          11.7386713028, 12.0605115891, 12.1289882660, 11.9917612076,
          11.2230424881, 9.6463003159,  8.6936531067,  7.9956026077,
          7.1304697990,  6.6271662712,  6.3617510796,  6.5671806335,
          7.2155175209,  8.7207698822,  10.4046106339, 12.2503290176,
          13.3407497406, 13.9519729614, 13.8466548920, 13.6002759933,
          12.8206014633, 12.7126827240, 12.7570552826, 13.5155019760,
          14.4871845245, 15.9497089386, 17.1229877472, 17.9090995789,
      },
      {
          9.4527854919,  9.4371728897,  9.4779844284,  9.4196424484,
          9.4196424484,  9.4196424484,  9.4196424484,  9.4196424484,
          9.4196424484,  9.4196424484,  9.4196424484,  9.4378576279,
          9.4559354782,  9.4922275543,  9.5285205841,  9.5271501541,
          9.5452280045,  9.6034336090,  9.9808759689,  10.9440689087,
          11.7386713028, 12.0605115891, 12.1289882660, 11.9917612076,
          11.2230424881, 9.6463003159,  8.6936531067,  7.9956026077,
          7.1304697990,  6.6271662712,  6.3617510796,  6.5671806335,
          7.2155175209,  8.7207698822,  10.4046106339, 12.2503290176,
          13.3407497406, 13.9519729614, 13.8466548920, 13.6002759933,
          12.8206014633, 12.7126827240, 12.7570552826, 13.5155019760,
          14.4871845245, 15.9497089386, 17.1229877472, 17.9090995789,
      },
      {
          0.9982600212,
          0.9982590079,
          0.9982569814,
          0.9982560277,
          0.9982540011,
          0.9982529879,
          0.9982519746,
          0.9982500076,
          0.9995471835,
          0.9995467663,
          0.0000000000,
          0.0000000000,
          3615010085404672.0000000000,
          0.0000000000,
          0.0000000082,
          34970345144320.0000000000,
          0.9942929745,
          0.9942889810,
          0.9942839742,
          0.9942799807,
          0.9942749739,
          0.9942709804,
          0.9942659736,
          0.9942619801,
          0.9942569733,
          0.9942529798,
          0.9942479730,
          0.9942439795,
          0.9942389727,
          0.9942349792,
          0.9942299724,
          0.9942250252,
          0.9942209721,
          0.9942160249,
          0.9942119718,
          0.9942070246,
          0.9942029715,
          0.9941980243,
          0.9941930175,
          0.9941890240,
          0.9941840172,
          0.9941800237,
          0.9941750169,
          0.9941700101,
          0.9941660166,
          0.9941610098,
          0.9941570163,
          0.9941520095,
      },
      {
          0.9983143210, 0.9983129501, 0.9983116388, 0.9983102679, 0.9983089566,
          0.9983075857, 0.9983062744, 0.9983049035, 0.9983035922, 0.9983022213,
          0.9983008504, 0.9982995391, 0.9982981682, 0.9982967973, 0.9982954860,
          0.9982941151, 0.9982927442, 0.9982914329, 0.9982900620, 0.9982886910,
          0.9982873201, 0.9982860088, 0.9982846379, 0.9982832670, 0.9982818961,
          0.9982805252, 0.9982791543, 0.9982777834, 0.9982764125, 0.9982751012,
          0.9982737303, 0.9982723594, 0.9982709885, 0.9982696176, 0.9982682467,
          0.9982668161, 0.9982654452, 0.9982640743, 0.9982627034, 0.9982613325,
          0.9982599616, 0.9982585907, 0.9982572198, 0.9982557893, 0.9982544184,
          0.9982530475, 0.9982516766, 0.9982502460,
      },
      {
          0.9943114519, 0.9943069220, 0.9943024516, 0.9942979217, 0.9942934513,
          0.9942889214, 0.9942843914, 0.9942799211, 0.9942753911, 0.9942708611,
          0.9942663312, 0.9942618012, 0.9942572713, 0.9942527413, 0.9942481518,
          0.9942436218, 0.9942390919, 0.9942345619, 0.9942299724, 0.9942254424,
          0.9942208529, 0.9942162633, 0.9942117333, 0.9942071438, 0.9942025542,
          0.9941979647, 0.9941933751, 0.9941887856, 0.9941841960, 0.9941796064,
          0.9941750169, 0.9941704273, 0.9941658378, 0.9941611886, 0.9941565990,
          0.9941519499, 0.9941473603, 0.9941427112, 0.9941381216, 0.9941334724,
          0.9941288233, 0.9941241741, 0.9941195846, 0.9941149354, 0.9941102862,
          0.9941056371, 0.9941009283, 0.9940962791,
      },
      {
          0.9789918065, 0.9789754748, 0.9789591432, 0.9789427519, 0.9789263606,
          0.9789099693, 0.9788935781, 0.9788771272, 0.9788606763, 0.9788442850,
          0.9788277745, 0.9788113236, 0.9787948728, 0.9787783623, 0.9787618518,
          0.9787453413, 0.9787287712, 0.9787122607, 0.9786956906, 0.9786791205,
          0.9786625504, 0.9786459208, 0.9786293507, 0.9786127210, 0.9785960913,
          0.9785794020, 0.9785627723, 0.9785460830, 0.9785293937, 0.9785127044,
          0.9784960151, 0.9784792662, 0.9784625173, 0.9784457684, 0.9784290195,
          0.9784122705, 0.9783954620, 0.9783786535, 0.9783618450, 0.9783450365,
          0.9783281684, 0.9783113599, 0.9782944918, 0.9782776237, 0.9782606959,
          0.9782438278, 0.9782269001, 0.9782099724,
      },
      {
          0.9255065322, 0.9254517555, 0.9253969193, 0.9253420830, 0.9252871275,
          0.9252322316, 0.9251772165, 0.9251222014, 0.9250671864, 0.9250120521,
          0.9249569774, 0.9249017835, 0.9248465896, 0.9247913361, 0.9247360826,
          0.9246807694, 0.9246253967, 0.9245700240, 0.9245145917, 0.9244591594,
          0.9244036674, 0.9243481159, 0.9242925048, 0.9242368937, 0.9241812825,
          0.9241255522, 0.9240698814, 0.9240140915, 0.9239583015, 0.9239024520,
          0.9238466024, 0.9237906933, 0.9237347245, 0.9236787558, 0.9236227274,
          0.9235666394, 0.9235105515, 0.9234544039, 0.9233982563, 0.9233419895,
          0.9232857823, 0.9232294559, 0.9231731296, 0.9231168032, 0.9230603576,
          0.9230039120, 0.9229474664, 0.9228909612,
      },
      {
          0.7681061625, 0.7679646611, 0.7678230405, 0.7676814198, 0.7675396800,
          0.7673978806, 0.7672560811, 0.7671141624, 0.7669721842, 0.7668301463,
          0.7666881084, 0.7665459514, 0.7664037347, 0.7662615180, 0.7661191821,
          0.7659767866, 0.7658343315, 0.7656918168, 0.7655493021, 0.7654066682,
          0.7652639747, 0.7651212215, 0.7649784088, 0.7648355365, 0.7646926641,
          0.7645496726, 0.7644066215, 0.7642635107, 0.7641203403, 0.7639771104,
          0.7638338208, 0.7636904716, 0.7635470629, 0.7634036541, 0.7632601261,
          0.7631165385, 0.7629728913, 0.7628291845, 0.7626854181, 0.7625415921,
          0.7623977065, 0.7622537613, 0.7621097565, 0.7619656920, 0.7618215680,
          0.7616773844, 0.7615331411, 0.7613888383,
      },
      {
          0.4689567387, 0.4687588811, 0.4685610533, 0.4683632255, 0.4681654274,
          0.4679675996, 0.4677698016, 0.4675720334, 0.4673742652, 0.4671764970,
          0.4669787288, 0.4667809904, 0.4665832520, 0.4663855433, 0.4661878347,
          0.4659901261, 0.4657924473, 0.4655947685, 0.4653970897, 0.4651994407,
          0.4650017917, 0.4648041427, 0.4646065235, 0.4644089043, 0.4642113149,
          0.4640136957, 0.4638161361, 0.4636185467, 0.4634209871, 0.4632234573,
          0.4630259275, 0.4628283978, 0.4626308978, 0.4624333978, 0.4622358978,
          0.4620384276, 0.4618409574, 0.4616435170, 0.4614460766, 0.4612486362,
          0.4610512257, 0.4608538151, 0.4606564343, 0.4604590535, 0.4602616727,
          0.4600643218, 0.4598669708, 0.4596696496,
      },
      {
          0.2067507505, 0.2066204846, 0.2064902782, 0.2063601315, 0.2062300444,
          0.2061000317, 0.2059700638, 0.2058401704, 0.2057103217, 0.2055805475,
          0.2054508328, 0.2053211629, 0.2051915675, 0.2050620317, 0.2049325556,
          0.2048031390, 0.2046737969, 0.2045444995, 0.2044152617, 0.2042860985,
          0.2041569799, 0.2040279359, 0.2038989365, 0.2037700117, 0.2036411464,
          0.2035123259, 0.2033835799, 0.2032548934, 0.2031262666, 0.2029976994,
          0.2028691918, 0.2027407587, 0.2026123703, 0.2024840415, 0.2023557872,
          0.2022275776, 0.2020994425, 0.2019713670, 0.2018433362, 0.2017153800,
          0.2015874833, 0.2014596462, 0.2013318688, 0.2012041509, 0.2010764927,
          0.2009488940, 0.2008213699, 0.2006938905,
      },
  };
  for (size_t chan = 0; chan < kNumRotators / 10; chan++) {
    for (size_t i = 0; i < 48; i++) {
      assert(spectrogram[{chan * kNumRotators / 10}][i] == want_spec[chan][i]);
    }
  }
}

}  // namespace

}  // namespace zimtohrli
